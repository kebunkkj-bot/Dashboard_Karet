<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Karet (Produksi)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Latar belakang abu-abu muda */
        }

        .kpi-card {
            background-color: white;
            border-radius: 12px;
            /* Lebih bulat */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px;
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            /* Border tipis */
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }

        .kpi-title {
            font-size: 1rem;
            /* 16px */
            font-weight: 500;
            color: #4b5563;
            /* Gray-600 */
            margin-bottom: 16px;
            /* Jarak lebih */
            display: flex;
            align-items: center;
        }

        .kpi-title svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            color: #6b7280;
            /* Gray-500 */
        }

        .kpi-value {
            font-size: 2.25rem;
            /* 36px */
            font-weight: 700;
            color: #111827;
            /* Gray-900 */
            line-height: 1.2;
        }

        .kpi-detail {
            font-size: 0.875rem;
            /* 14px */
            color: #6b7280;
            /* Gray-500 */
            margin-top: 8px;
        }

        .kpi-percent {
            font-size: 1.125rem;
            /* 18px */
            font-weight: 600;
        }

        .positive {
            color: #10b981;
            /* Green-500 */
        }

        .negative {
            color: #ef4444;
            /* Red-500 */
        }

        .neutral {
            color: #6b7280;
            /* Gray-500 */
        }

        /* Styling untuk Tabel Detail */
        .detail-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            /* Penting agar tabel tidak merusak radius */
        }

        .detail-header {
            padding: 16px 24px;
            background-color: #f9fafb;
            /* Gray-50 */
            border-bottom: 1px solid #e5e7eb;
        }

        .tab-controls {
            display: flex;
            flex-wrap: wrap;
            /* Membungkus jika tidak cukup */
            justify-content: flex-start;
            /* Rata kiri (default) */
            gap: 8px;
            /* Jarak antar tombol */
            padding: 16px 24px;
            background-color: #f9fafb;
            /* Latar belakang abu-abu sangat muda */
        }

        .tab-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 8px;
            /* Melengkung di semua sudut */
            border: 1px solid transparent;
            background-color: #e5e7eb;
            /* Abu-abu tidak aktif */
            color: #6b7280;
            /* Teks abu-abu */
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background-color: #d1d5db;
            /* Abu-abu lebih gelap saat hover */
        }

        .tab-button.active {
            background-color: #3b82f6;
            /* Biru saat aktif */
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .tab-button.active svg {
            color: white;
        }

        .tab-button svg {
            width: 16px;
            height: 16px;
        }

        .tab-content {
            display: none;
            /* Sembunyi secara default */
            padding: 0;
            /* Padding diatur oleh wrapper tabel */
        }

        .tab-content.active {
            display: block;
            /* Tampil saat aktif */
        }


        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            /* Scroll horizontal jika perlu */
            -webkit-overflow-scrolling: touch;
            padding: 24px;
            /* Padding di dalam card, di luar tabel */
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            /* Hapus spasi antar sel */
            border-spacing: 0;
            border: 1px solid #e5e7eb;
            /* Border luar */
            border-radius: 8px;
            /* Sudut melengkung (meskipun overflow hidden di parent lebih efektif) */
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
            /* 14px */
        }

        /* Header Tabel */
        .data-table thead th {
            background-color: #f9fafb;
            /* Gray-50 */
            font-weight: 600;
            color: #374151;
            /* Gray-700 */
            vertical-align: middle;
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
            /* Garis header lebih tebal */
            border-right: 1px solid #e5e7eb;
            /* Garis vertikal */
        }

        .data-table thead th:last-child {
            border-right: 0;
        }

        .data-table thead th[rowspan="2"] {
            vertical-align: middle;
        }

        /* Body Tabel */
        .data-table tbody tr:hover {
            background-color: #f9fafb;
            /* Highlight saat hover */
        }

        .data-table tbody td {
            color: #1f2937;
            /* Gray-800 */
            text-align: right;
            vertical-align: top;
            /* Rata atas untuk data */
            border-right: 1px solid #e5e7eb;
        }

        .data-table tbody td:last-child {
            border-right: 0;
        }

        /* Kolom Teks (Afdeling, Mandor) */
        .data-table tbody td:first-child,
        .data-table tbody td.text-left {
            text-align: left;
            font-weight: 500;
            color: #111827;
        }

        /* Footer Tabel (Total) */
        .data-table tfoot tr {
            background-color: #f9fafb;
            /* Latar abu-abu untuk total */
            border-top: 2px solid #e5e7eb;
            /* Garis tebal di atas total */
        }

        .data-table tfoot td {
            font-weight: 700;
            /* Bold */
            color: #111827;
            /* Hitam */
            text-align: right;
            vertical-align: top;
            border-right: 1px solid #e5e7eb;
        }

        .data-table tfoot td:last-child {
            border-right: 0;
        }

        .data-table tfoot td:first-child {
            text-align: center;
            /* Total rata tengah */
        }

        /* Filter Header */
        .filter-header {
            padding: 24px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            /* Bungkus jika layar kecil */
            gap: 16px;
        }

        .filter-header h1 {
            font-size: 1.5rem;
            /* 24px */
            font-weight: 700;
            color: #111827;
        }

        .filter-header .date-filter {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .filter-header label {
            font-weight: 500;
            color: #374151;
        }

        .filter-header input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            /* Gray-300 */
            border-radius: 8px;
            font-size: 0.875rem;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* Chart Card */
        .chart-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px;
            border: 1px solid #e5e7eb;
            height: 400px;
            /* Tinggi tetap untuk konsistensi */
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }

        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #3b82f6;
            /* Biru */
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        #loading-overlay p {
            font-weight: 500;
            color: #1f2937;
            margin-top: 16px;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="loader"></div>
        <p>Mengambil data terbaru...</p>
    </div>

    <!-- Header Filter -->
    <div class="filter-header mb-6">
        <h1>Dashboard Produksi Karet</h1>
        <div class="date-filter">
            <label for="date-selector">Filter Tanggal (YTD):</label>
            <input type="date" id="date-selector">
        </div>
    </div>

    <!-- Grid KPI -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">

        <!-- KPI 1: Produksi Hari Ini (Kg) -->
        <div class="kpi-card">
            <h2 class="kpi-title"><i data-feather="package"></i>Produksi Hari Ini (Kg)</h2>
            <div id="kpi-prod-today-value" class="kpi-value">0</div>
            <div class="kpi-detail">
                vs RKAP: <span id="kpi-prod-today-rkap" class="neutral">0</span> |
                vs 2024: <span id="kpi-prod-today-2024" class="neutral">0</span>
            </div>
        </div>

        <!-- KPI 2: Produksi Bulan Ini (YTD) -->
        <div class="kpi-card">
            <h2 class="kpi-title"><i data-feather="calendar"></i>Produksi s.d. Bulan Ini (Kg)</h2>
            <div id="kpi-prod-ytd-value" class="kpi-value">0</div>
            <div class="kpi-detail">
                Pencapaian vs RKAP: <span id="kpi-prod-ytd-percent" class="kpi-percent neutral">0%</span>
            </div>
        </div>

        <!-- KPI 3: OHK Hari Ini -->
        <div class="kpi-card">
            <h2 class="kpi-title"><i data-feather="users"></i>OHK Hari Ini</h2>
            <div id="kpi-ohk-today-value" class="kpi-value">0</div>
            <div class="kpi-detail">
                vs RKAP: <span id="kpi-ohk-today-rkap" class="neutral">0</span> |
                vs 2024: <span id="kpi-ohk-today-2024" class="neutral">0</span>
            </div>
        </div>

        <!-- KPI 4: OHK s.d. Bulan Ini -->
        <div class="kpi-card">
            <h2 class="kpi-title"><i data-feather="briefcase"></i>OHK s.d. Bulan Ini</h2>
            <div id="kpi-ohk-ytd-value" class="kpi-value">0</div>
            <div class="kpi-detail">
                Pencapaian vs RKAP: <span id="kpi-ohk-ytd-percent" class="kpi-percent neutral">0%</span>
            </div>
        </div>
    </div>

    <!-- Card Detail (Tabel & Tab) -->
    <div class="detail-card mb-6">
        <!-- Kontrol Tab -->
        <div class="tab-controls">
            <button id="tab-afdeling" class="tab-button active" data-target="content-afdeling">
                <i data-feather="map-pin"></i>Per Afdeling
            </button>
            <button id="tab-mandor" class="tab-button" data-target="content-mandor">
                <i data-feather="users"></i>Per Mandor
            </button>
            <button id="tab-asisten" class="tab-button" data-target="content-asisten">
                <i data-feather="user"></i>Per Asisten Afdeling
            </button>
            <button id="tab-tahuntanam" class="tab-button" data-target="content-tahuntanam">
                <i data-feather="calendar"></i>Per Tahun Tanam
            </button>
            <button id="tab-tapper" class="tab-button" data-target="content-tapper">
                <i data-feather="tool"></i>Per Tapper
            </button>
        </div>

        <!-- Konten Tab -->
        <div class="tab-content active" id="content-afdeling">
            <div class="table-wrapper">
                <table class="data-table" id="afdeling-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Afdeling</th>
                            <th rowspan="2">Luas (Ha)</th>
                            <th colspan="2">Hari Ini (Kg)</th>
                            <th colspan="2">Bulan Ini (Kg)</th>
                            <th colspan="2">s.d. Bulan Ini (YTD) (Kg)</th>
                            <th colspan="2">s.d. Tahun Ini (YTD) (%)</th>
                        </tr>
                        <tr>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                        </tr>
                    </thead>
                    <tbody id="afdeling-table-body">
                        <!-- Data diisi oleh JavaScript -->
                    </tbody>
                    <tfoot id="afdeling-table-footer">
                        <!-- Total diisi oleh JavaScript -->
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="tab-content" id="content-mandor">
            <div class="table-wrapper">
                <table class="data-table" id="mandor-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Mandor</th>
                            <th rowspan="2">Luas (Ha)</th>
                            <th colspan="2">Hari Ini (Kg)</th>
                            <th colspan="2">Bulan Ini (Kg)</th>
                            <th colspan="2">s.d. Bulan Ini (YTD) (Kg)</th>
                            <th colspan="2">s.d. Tahun Ini (YTD) (%)</th>
                        </tr>
                        <tr>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                        </tr>
                    </thead>
                    <tbody id="mandor-table-body">
                        <!-- Data diisi oleh JavaScript -->
                    </tbody>
                    <tfoot id="mandor-table-footer">
                        <!-- Total diisi oleh JavaScript -->
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="tab-content" id="content-asisten">
            <div class="table-wrapper">
                <table class="data-table" id="asisten-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Asisten Afdeling</th>
                            <th rowspan="2">Luas (Ha)</th>
                            <th colspan="2">Hari Ini (Kg)</th>
                            <th colspan="2">Bulan Ini (Kg)</th>
                            <th colspan="2">s.d. Bulan Ini (YTD) (Kg)</th>
                            <th colspan="2">s.d. Tahun Ini (YTD) (%)</th>
                        </tr>
                        <tr>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                        </tr>
                    </thead>
                    <tbody id="asisten-table-body">
                        <!-- Data diisi oleh JavaScript -->
                    </tbody>
                    <tfoot id="asisten-table-footer">
                        <!-- Total diisi oleh JavaScript -->
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="tab-content" id="content-tahuntanam">
            <div class="table-wrapper">
                <table class="data-table" id="tahuntanam-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Tahun Tanam</th>
                            <th rowspan="2">Luas (Ha)</th>
                            <th colspan="2">Hari Ini (Kg)</th>
                            <th colspan="2">Bulan Ini (Kg)</th>
                            <th colspan="2">s.d. Bulan Ini (YTD) (Kg)</th>
                            <th colspan="2">s.d. Tahun Ini (YTD) (%)</th>
                        </tr>
                        <tr>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                        </tr>
                    </thead>
                    <tbody id="tahuntanam-table-body">
                        <!-- Data diisi oleh JavaScript -->
                    </tbody>
                    <tfoot id="tahuntanam-table-footer">
                        <!-- Total diisi oleh JavaScript -->
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="tab-content" id="content-tapper">
            <div class="table-wrapper">
                <table class="data-table" id="tapper-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Afdeling</th>
                            <th rowspan="2">Mandor</th>
                            <th rowspan="2">Hanca Wajib</th>
                            <th colspan="2">Hari Ini (Kg)</th>
                            <th colspan="2">Bulan Ini (Kg)</th>
                            <th colspan="2">s.d. Bulan Ini (YTD) (Kg)</th>
                            <th colspan="2">s.d. Tahun Ini (YTD) (%)</th>
                        </tr>
                        <tr>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                            <th>Aktual</th>
                            <th>RKAP</th>
                        </tr>
                    </thead>
                    <tbody id="tapper-table-body">
                        <!-- Data diisi oleh JavaScript -->
                    </tbody>
                    <tfoot id="tapper-table-footer">
                        <!-- Total diisi oleh JavaScript -->
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Grid Chart -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Chart 1: Produksi Bulanan -->
        <div class="chart-card">
            <canvas id="produksiChart"></canvas>
        </div>
        <!-- Chart 2: OHK Bulanan -->
        <div class="chart-card">
            <canvas id="ohkChart"></canvas>
        </div>
    </div>


    <!-- ============================================= -->
    <!--           SCRIPT UTAMA DASHBOARD              -->
    <!-- ============================================= -->
    <script>
        /* ------------------------------------- */
        /* Variabel Global             */
        /* ------------------------------------- */

        // Variabel Chart (dideklarasikan global agar bisa di-destroy)
        let prodChartInstance = null;
        let ohkChartInstance = null;
        let globalProcessedData = null; // Menyimpan data yang sudah diproses

        // Palet Warna
        const WARNA_BIRU = '#3b82f6'; // Aktual 2025
        const WARNA_ABU = '#9ca3af'; // Aktual 2024
        const WARNA_MERAH = '#ef4444'; // RKAP

        // Daftar Bulan (untuk label chart)
        const BULAN_LABELS = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];

        /* ------------------------------------- */
        /* Fungsi Inisialisasi            */
        /* ------------------------------------- */

        // Event listener utama yang dijalankan saat DOM siap
        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi ikon
            feather.replace();

            // Set tanggal filter hari ini
            initializeDateFilter();

            // Tambah event listener untuk filter tanggal
            document.getElementById('date-selector').addEventListener('change', (e) => {
                const selectedDate = e.target.value;
                if (globalProcessedData) {
                    // Jika data sudah ada, proses ulang (filter) tanpa fetch
                    console.log(`Memfilter ulang data untuk tanggal: ${selectedDate}`);
                    const filteredData = filterDataByDate(globalProcessedData, selectedDate);
                    updateAllUI(filteredData, selectedDate);
                } else {
                    // Jika data belum ada (jarang terjadi, tapi sbg fallback)
                    console.log(`Data global belum ada, mengambil data baru untuk: ${selectedDate}`);
                    fetchDataAndInitialize(selectedDate);
                }
            });

            // Tambah event listener untuk Tab
            setupTabControls();

            // Ambil data dan inisialisasi dashboard
            fetchDataAndInitialize(document.getElementById('date-selector').value);
        });

        /*
         * Mengambil data dan memulai update UI
         */
        async function fetchDataAndInitialize(filterTanggal) {
            try {
                // Tampilkan loading
                document.getElementById('loading-overlay').classList.remove('hidden');

                // 1. Ambil dan proses data
                const rawData = await fetchDataFromSheet();
                
                // 2. Simpan data mentah yang sudah diproses (untuk filter nanti)
                globalProcessedData = processRawData(rawData, filterTanggal); 

                // 3. Filter data berdasarkan tanggal yang dipilih
                const filteredData = filterDataByDate(globalProcessedData, filterTanggal);
                
                // 4. Update seluruh UI
                updateAllUI(filteredData, filterTanggal);

            } catch (error) {
                console.error("GAGAL TOTAL:", error.message);
                // Coba tampilkan data mock jika fetch gagal
                try {
                    console.warn("Mencoba memuat data cadangan (mock)...");
                    const mockData = getMockData(); // Ambil mock data
                    globalProcessedData = processRawData(mockData, filterTanggal);
                    const filteredMockData = filterDataByDate(globalProcessedData, filterTanggal);
                    updateAllUI(filteredMockData, filterTanggal);
                } catch (mockError) {
                    console.error("Gagal memuat data cadangan:", mockError.message);
                    alert("Gagal memuat data dashboard. Silakan periksa koneksi atau format data di Google Sheet.");
                }

            } finally {
                // Selalu sembunyikan loading
                setTimeout(() => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                }, 300); // Kasih jeda sedikit
            }
        }

        /*
         * Memperbarui semua komponen UI (KPI, Chart, Tabel)
         */
        function updateAllUI(data, filterTanggal) {
            // Ambil data KPI yang sudah diagregasi
            const kpiData = data.kpi;
            const filterDateObj = new Date(filterTanggal + 'T00:00:00'); // Set zona waktu lokal
            const filterBulan = filterDateObj.getMonth(); // 0-11
            const filterTahun = filterDateObj.getFullYear();

            // 1. Update KPI
            updateKPIs(kpiData);

            // 2. Update Chart
            renderMonthlyChart(data.bulanan.produksi, filterBulan, filterTahun);
            renderOHKChart(data.bulanan.ohk, filterBulan, filterTahun);

            // 3. Update Tabel Detail (berdasarkan data YTD yang sudah difilter)
            updateDetailTable('#afdeling-table', data.details.afdeling);
            updateDetailTable('#mandor-table', data.details.mandor);
            updateDetailTable('#asisten-table', data.details.asisten);
            updateDetailTable('#tahuntanam-table', data.details.tahuntanam);
            updateTapperTable(data.details.tapper);
        }


        /* ------------------------------------- */
        /* Fungsi Utilitas             */
        /* ------------------------------------- */

        /*
         * Inisialisasi filter tanggal ke hari ini
         */
        function initializeDateFilter() {
            const dateInput = document.getElementById('date-selector');
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        }

        /*
         * Setup kontrol tab
         */
        function setupTabControls() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    // Dapatkan target dari tombol (currentTarget)
                    const targetId = e.currentTarget.getAttribute('data-target');
                    
                    // Hapus aktif dari semua tab
                    tabs.forEach(t => t.classList.remove('active'));
                    // Tambah aktif ke tab yang diklik
                    e.currentTarget.classList.add('active');

                    // Sembunyikan semua konten
                    contents.forEach(c => c.classList.remove('active'));
                    // Tampilkan konten yang sesuai
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }

                    // Render ulang ikon (penting jika ikon ada di konten tab)
                    feather.replace();
                });
            });
        }

        /*
         * Format angka (Contoh: 1234567 -> "1.234.567")
         */
        function formatAngka(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return "0";
            }
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        /*
         * Format angka singkat (Contoh: 120000 -> 120 Rb)
         */
        function formatAngkaSingkat(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return "0";
            }
            num = Math.round(num);
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(1).replace('.', ',') + ' M';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace('.', ',') + ' Jt';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(0) + ' Rb';
            }
            return num.toString();
        }


        /*
         * Hitung persentase (Contoh: (50, 100) -> 50.0)
         */
        function hitungPersen(aktual, target) {
            if (target === 0 || target === null || target === undefined || isNaN(target)) {
                return 0; // Hindari pembagian dengan nol
            }
            return ((aktual / target) * 100);
        }

        /*
         * Helper untuk update kelas CSS persentase (positif/negatif)
         */
        function updatePercentClass(element, percent) {
            element.classList.remove('positive', 'negative', 'neutral');
            if (percent >= 100) {
                element.classList.add('positive');
            } else if (percent > 0) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
            element.textContent = `${percent.toFixed(1).replace('.', ',')}%`;
        }

        /*
         * Helper untuk update kelas CSS perbandingan (vs 2024 / vs RKAP)
         */
        function updateComparisonClass(element, aktual, banding) {
            element.classList.remove('positive', 'negative', 'neutral');
            const selisih = aktual - banding;
            if (selisih > 0) {
                element.classList.add('positive');
                element.textContent = `+${formatAngka(selisih)}`;
            } else if (selisih < 0) {
                element.classList.add('negative');
                element.textContent = `${formatAngka(selisih)}`; // Sudah ada minus
            } else {
                element.classList.add('neutral');
                element.textContent = `0`;
            }
        }

        /*
         * Mem-parse string CSV menjadi array objek.
         * @param {string} csvText - Teks CSV mentah.
         * @returns {Array<Object>} Array objek data.
         */
        function parseCSV(csvText) {
            try {
                const lines = csvText.replace(/\r/g, '').split('\n'); // Bersihkan karakter carriage return
                if (lines.length === 0) return [];

                // Ambil header, bersihkan dari spasi atau karakter aneh
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];

                // Loop dari baris 1 (data)
                for (let i = 1; i < lines.length; i++) {
                    
                    // --- PERBAIKAN: Melewatkan baris kosong atau tidak valid ---
                    if (!lines[i] || lines[i].trim().length === 0) {
                        // console.warn(`Melewatkan baris data ${i}: Baris kosong.`);
                        continue; // Lewati baris ini
                    }
                    
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));

                    // --- PERBAIKAN: Melewatkan baris jika jumlah kolom tidak cocok ---
                    if (values.length !== headers.length) {
                        console.warn(`Melewatkan baris data ${i}: Jumlah kolom (${values.length}) tidak cocok dengan header (${headers.length}). Data: ${lines[i]}`);
                        continue; // Lewati baris ini
                    }

                    let obj = {};
                    let isEmptyRow = true; // Tandai jika semua nilai kosong
                    for (let j = 0; j < headers.length; j++) {
                        const key = headers[j];
                        const value = values[j];
                        obj[key] = value;
                        if (value && value.length > 0) {
                            isEmptyRow = false;
                        }
                    }

                    // Jangan tambahkan jika barisnya benar-benar kosong setelah di-parse
                    if (!isEmptyRow) {
                        data.push(obj);
                    } else {
                        // console.warn(`Melewatkan baris data ${i}: Baris terdeteksi kosong setelah parse.`);
                    }
                }
                return data;
            } catch (error) {
                console.error("Kesalahan saat parsing CSV:", error.message);
                throw new Error(`Gagal mem-parsing CSV. Pastikan format data dan header sudah benar. Error: ${error.message}`);
            }
        }

        /*
         * Fungsi helper untuk membuat entri detail (struktur data).
         * Pindahkan ke scope global agar bisa diakses oleh processRawData dan updateDetailTable.
         */
        function createDetailEntry(luas) {
            return {
                luasHa: luas,
                todayAktual: 0, todayRKAP: 0,
                monthAktual: 0, monthRKAP: 0,
                ytdAktual: 0, ytdRKAP: 0,
                yearAktual: 0, yearRKAP: 0, // yearRKAP diambil dari YTD bulanan
                hancaWajib: 0 // Khusus tapper
            };
        }


        /* ------------------------------------- */
        /* Fungsi Pengambilan Data        */
        /* ------------------------------------- */

        /*
         * Mengambil data dari Google Sheet (atau Mock jika gagal)
         */
        async function fetchDataFromSheet() {
            // Tampilkan loading overlay
            document.getElementById('loading-overlay').classList.remove('hidden');

            // URL Google Sheet LIVE Anda (diambil dari GID dan ID Sheet)
            // PASTIKAN INI ADALAH URL PUBLIKASI CSV ANDA
            const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTjNtFERkivPI8-gwiXCdCVOSGKAWB4FF-UbKj-Q4LzOTCzBX44eI_kV2q2qLxj1q_5c-cyfysqOaSU/pub?gid=142978215&single=true&output=csv';
            
            console.log("Mencoba mengambil data dari:", SHEET_URL);

            try {
                const response = await fetch(SHEET_URL, {
                    method: 'GET',
                    redirect: 'follow' // Penting untuk Google Sheets
                });

                if (!response.ok) {
                    throw new Error(`Gagal mengambil data dari Google Sheet. Status: ${response.status} ${response.statusText}`);
                }

                const csvText = await response.text();
                
                if (!csvText || csvText.length === 0) {
                     throw new Error("Data CSV yang diterima kosong. Periksa publikasi Google Sheet.");
                }

                console.log("Berhasil mengambil data CSV, ukuran:", csvText.length);
                
                const jsonData = parseCSV(csvText);
                
                if (jsonData.length === 0) {
                    throw new Error("Data CSV berhasil di-parse, namun hasilnya kosong. Periksa isi Google Sheet.");
                }

                console.log(`Berhasil mem-parsing ${jsonData.length} baris data.`);
                return jsonData;

            } catch (error) {
                console.error("Gagal mengambil data live:", error.message);
                throw error; // Lemparkan error agar ditangkap oleh fetchDataAndInitialize
            }
        }

        /*
         * Menyediakan data cadangan (mock) jika fetch gagal
         */
        function getMockData() {
            console.warn("MENGGUNAKAN DATA CADANGAN (MOCK)");
            // Menyediakan beberapa baris data harian sebagai cadangan
            // Pastikan header (key) SAMA PERSIS dengan panduan_sheets.md
            return [
                {
                    Tanggal: "2025-01-01", Prod_Kg: "5000", OHK: "200", Afdeling: "A", Mandor: "Mandor 1", Tapper: "T001", LuasHa: "100.5", Tahun_Tanam: "2018", Asisten_Afdeling: "Asisten 1",
                    RKAP_Harian: "4800", Prod_2024_Harian: "4900", RKAP_Harian_OHK: "190", OHK_2024_Harian: "195",
                    RKAP_2025_YTD: "150000", Target_2024_YTD: "140000", RKAP_2025_OHK_YTD: "6000", Target_2024_OHK_YTD: "5800"
                },
                {
                    Tanggal: "2025-01-01", Prod_Kg: "4000", OHK: "180", Afdeling: "B", Mandor: "Mandor 2", Tapper: "T002", LuasHa: "90.2", Tahun_Tanam: "2019", Asisten_Afdeling: "Asisten 2",
                    RKAP_Harian: "4000", Prod_2024_Harian: "4100", RKAP_Harian_OHK: "170", OHK_2024_Harian: "175",
                    RKAP_2025_YTD: "150000", Target_2024_YTD: "140000", RKAP_2025_OHK_YTD: "6000", Target_2024_OHK_YTD: "5800"
                },
                {
                    Tanggal: "2025-01-02", Prod_Kg: "5100", OHK: "210", Afdeling: "A", Mandor: "Mandor 1", Tapper: "T001", LuasHa: "100.5", Tahun_Tanam: "2018", Asisten_Afdeling: "Asisten 1",
                    RKAP_Harian: "4800", Prod_2024_Harian: "4950", RKAP_Harian_OHK: "190", OHK_2024_Harian: "195",
                    RKAP_2025_YTD: "150000", Target_2024_YTD: "140000", RKAP_2025_OHK_YTD: "6000", Target_2024_OHK_YTD: "5800"
                },
                {
                    Tanggal: "2025-02-01", Prod_Kg: "6000", OHK: "220", Afdeling: "A", Mandor: "Mandor 1", Tapper: "T003", LuasHa: "100.5", Tahun_Tanam: "2018", Asisten_Afdeling: "Asisten 1",
                    RKAP_Harian: "5800", Prod_2024_Harian: "5900", RKAP_Harian_OHK: "210", OHK_2024_Harian: "215",
                    RKAP_2025_YTD: "140000", Target_2024_YTD: "130000", RKAP_2025_OHK_YTD: "5500", Target_2024_OHK_YTD: "5300"
                },
                 {
                    Tanggal: "2025-02-01", Prod_Kg: "4500", OHK: "190", Afdeling: "B", Mandor: "Mandor 2", Tapper: "T004", LuasHa: "90.2", Tahun_Tanam: "2019", Asisten_Afdeling: "Asisten 2",
                    RKAP_Harian: "4500", Prod_2024_Harian: "4600", RKAP_Harian_OHK: "180", OHK_2024_Harian: "185",
                    RKAP_2025_YTD: "140000", Target_2024_YTD: "130000", RKAP_2025_OHK_YTD: "5500", Target_2024_OHK_YTD: "5300"
                }
            ];
        }


        /* ------------------------------------- */
        /* Fungsi Pemrosesan Data         */
        /* ------------------------------------- */

        /*
         * Mengubah data mentah (array) menjadi struktur data siap pakai.
         * Ini hanya dijalankan sekali saat fetch awal.
         * @param {Array<Object>} data - Data mentah dari CSV.
         * @param {string} filterTanggal - Tanggal (YYYY-MM-DD).
         * @returns {Object} Data yang sudah diproses.
         */
        function processRawData(data, filterTanggal) {
            console.log("Memulai pemrosesan data mentah...");
            
            const processedData = {
                kpi: {
                    today: { prodAktual: 0, prodRKAP: 0, prod2024: 0, ohkAktual: 0, ohkRKAP: 0, ohk2024: 0 },
                    ytd: { prodAktual: 0, prodRKAP: 0, prod2024: 0, ohkAktual: 0, ohkRKAP: 0, ohk2024: 0 }
                },
                bulanan: {
                    produksi: Array(12).fill(null).map(() => ({ aktual: 0, rkap: 0, prevYear: 0 })),
                    ohk: Array(12).fill(null).map(() => ({ aktual: 0, rkap: 0, prevYear: 0 }))
                },
                details: {
                    afdeling: {},
                    mandor: {},
                    asisten: {},
                    tahuntanam: {},
                    tapper: {}
                }
            };

            const uniqueAfdeling = {};
            const uniqueMandor = {};
            const uniqueAsisten = {};
            const uniqueTahunTanam = {};
            const uniqueTapper = {};

            // 1. Inisialisasi struktur detail (berdasarkan data unik)
            data.forEach(row => {
                const luas = parseFloat(row.LuasHa) || 0;

                if (row.Afdeling && !uniqueAfdeling[row.Afdeling]) {
                    uniqueAfdeling[row.Afdeling] = { luas: 0 };
                }
                if (row.Afdeling) uniqueAfdeling[row.Afdeling].luas += luas; // Ini akan menjumlahkan jika ada duplikat, perlu penanganan unik

                if (row.Mandor && !uniqueMandor[row.Mandor]) {
                    uniqueMandor[row.Mandor] = { luas: 0 };
                }
                if (row.Mandor) uniqueMandor[row.Mandor].luas += luas;

                if (row.Asisten_Afdeling && !uniqueAsisten[row.Asisten_Afdeling]) {
                    uniqueAsisten[row.Asisten_Afdeling] = { luas: 0 };
                }
                if (row.Asisten_Afdeling) uniqueAsisten[row.Asisten_Afdeling].luas += luas;

                if (row.Tahun_Tanam && !uniqueTahunTanam[row.Tahun_Tanam]) {
                    uniqueTahunTanam[row.Tahun_Tanam] = { luas: 0 };
                }
                if (row.Tahun_Tanam) uniqueTahunTanam[row.Tahun_Tanam].luas += luas;
                
                const tapperKey = `${row.Afdeling}-${row.Mandor}-${row.Tapper}`;
                 if (row.Tapper && !uniqueTapper[tapperKey]) {
                    uniqueTapper[tapperKey] = { 
                        afdeling: row.Afdeling, 
                        mandor: row.Mandor, 
                        tapper: row.Tapper, 
                        hanca: 0, // Hanca Wajib (asumsi 0 jika tidak ada)
                        luas: 0 
                    };
                }
                // (Catatan: Hanca wajib dan luas per tapper perlu di-handle khusus jika datanya ada)
            });

            // Inisialisasi struktur detail dari data unik
            Object.keys(uniqueAfdeling).forEach(key => {
                processedData.details.afdeling[key] = createDetailEntry(uniqueAfdeling[key].luas);
            });
            Object.keys(uniqueMandor).forEach(key => {
                processedData.details.mandor[key] = createDetailEntry(uniqueMandor[key].luas);
            });
             Object.keys(uniqueAsisten).forEach(key => {
                processedData.details.asisten[key] = createDetailEntry(uniqueAsisten[key].luas);
            });
             Object.keys(uniqueTahunTanam).forEach(key => {
                processedData.details.tahuntanam[key] = createDetailEntry(uniqueTahunTanam[key].luas);
            });
             Object.keys(uniqueTapper).forEach(key => {
                const t = uniqueTapper[key];
                processedData.details.tapper[key] = createDetailEntry(t.luas);
                processedData.details.tapper[key].afdeling = t.afdeling;
                processedData.details.tapper[key].mandor = t.mandor;
                processedData.details.tapper[key].tapper = t.tapper;
                processedData.details.tapper[key].hancaWajib = t.hanca;
            });
            
            // 2. Simpan data bulanan (Target & 2024)
            // Ini akan mengambil nilai YTD/Bulanan dari baris data terakhir per bulan
            const bulananMemory = {};
            data.forEach(row => {
                try {
                    const rowDate = new Date(row.Tanggal + 'T00:00:00');
                    const bulan = rowDate.getMonth(); // 0-11
                    const tahun = rowDate.getFullYear();
                    
                    if (tahun < 2025) return; // Hanya proses data 2025

                    const key = `${tahun}-${bulan}`;
                    
                    // Kita asumsikan data _YTD sama untuk semua baris di bulan yg sama
                    if (!bulananMemory[key]) {
                        bulananMemory[key] = true; // Tandai bulan ini sudah diproses

                        const prodRKAP = parseFloat(row.RKAP_2025_YTD) || 0;
                        const prod2024 = parseFloat(row.Target_2024_YTD) || 0;
                        const ohkRKAP = parseFloat(row.RKAP_2025_OHK_YTD) || 0;
                        const ohk2024 = parseFloat(row.Target_2024_OHK_YTD) || 0;

                        // Simpan target bulanan penuh
                        processedData.bulanan.produksi[bulan].rkap = prodRKAP;
                        processedData.bulanan.produksi[bulan].prevYear = prod2024;
                        processedData.bulanan.ohk[bulan].rkap = ohkRKAP;
                        processedData.bulanan.ohk[bulan].prevYear = ohk2024;
                    }

                    // 3. Akumulasi data aktual (YTD)
                    // (Ini akan menjumlahkan data harian 2025)
                    const prodAktual = parseFloat(row.Prod_Kg) || 0;
                    const ohkAktual = parseFloat(row.OHK) || 0;
                    
                    processedData.bulanan.produksi[bulan].aktual += prodAktual;
                    processedData.bulanan.ohk[bulan].aktual += ohkAktual;

                } catch (e) {
                    console.warn(`Gagal memproses baris data bulanan: ${e.message}`, row);
                }
            });

            // 4. Simpan data mentah (harian) untuk filtering
            // (Kita tambahkan data mentah ke objek)
            processedData.harian = data;

            console.log("Selesai memproses data mentah.", processedData);
            return processedData;
        }

        /*
         * Memfilter data yang sudah diproses berdasarkan tanggal
         * @param {Object} processedData - Data dari processRawData()
         * @param {string} filterTanggal - Tanggal (YYYY-MM-DD)
         * @returns {Object} Data yang sudah difilter siap untuk UI
         */
        function filterDataByDate(processedData, filterTanggal) {
            console.log(`Memulai filter untuk tanggal: ${filterTanggal}`);

            // Buat salinan (deep copy) agar tidak mengubah data global
            let filteredData = JSON.parse(JSON.stringify(processedData));
            
            // Reset KPI dan Detail ke 0 sebelum diisi ulang
            filteredData.kpi = {
                today: { prodAktual: 0, prodRKAP: 0, prod2024: 0, ohkAktual: 0, ohkRKAP: 0, ohk2024: 0 },
                ytd: { prodAktual: 0, prodRKAP: 0, prod2024: 0, ohkAktual: 0, ohkRKAP: 0, ohk2024: 0 }
            };
            Object.keys(filteredData.details).forEach(tipe => {
                 Object.keys(filteredData.details[tipe]).forEach(key => {
                    const entry = filteredData.details[tipe][key];
                    // Reset angka, tapi pertahankan info (afdeling, mandor, luas)
                    entry.todayAktual = 0; entry.todayRKAP = 0;
                    entry.monthAktual = 0; entry.monthRKAP = 0;
                    entry.ytdAktual = 0; entry.ytdRKAP = 0;
                    entry.yearAktual = 0; entry.yearRKAP = 0;
                    entry.hancaWajib = 0; 
                 });
            });

            const filterDateObj = new Date(filterTanggal + 'T00:00:00');
            const filterBulan = filterDateObj.getMonth(); // 0-11
            const filterTahun = filterDateObj.getFullYear();
            const filterTglString = filterTanggal;

            // Loop data harian (dari data global)
            processedData.harian.forEach(row => {
                const rowDate = new Date(row.Tanggal + 'T00:00:00');
                const rowBulan = rowDate.getMonth();
                const rowTahun = rowDate.getFullYear();

                if (rowTahun !== filterTahun) return; // Hanya proses tahun yang difilter

                // Konversi data mentah (string) ke angka (float)
                const prodAktual = parseFloat(row.Prod_Kg) || 0;
                const prodRKAP = parseFloat(row.RKAP_Harian) || 0;
                const prod2024 = parseFloat(row.Prod_2024_Harian) || 0;
                
                const ohkAktual = parseFloat(row.OHK) || 0;
                const ohkRKAP = parseFloat(row.RKAP_Harian_OHK) || 0;
                const ohk2024 = parseFloat(row.OHK_2024_Harian) || 0;

                const hancaWajib = parseFloat(row.Hanca_Wajib) || 0; // Jika ada

                // 1. Hitung KPI "Hari Ini" (Hanya jika tanggalnya cocok)
                if (row.Tanggal === filterTglString) {
                    filteredData.kpi.today.prodAktual += prodAktual;
                    filteredData.kpi.today.prodRKAP += prodRKAP;
                    filteredData.kpi.today.prod2024 += prod2024;
                    filteredData.kpi.today.ohkAktual += ohkAktual;
                    filteredData.kpi.today.ohkRKAP += ohkRKAP;
                    filteredData.kpi.today.ohk2024 += ohk2024;
                }

                // 2. Hitung KPI YTD (Akumulasi s.d. tanggal filter)
                if (rowDate <= filterDateObj) {
                    filteredData.kpi.ytd.prodAktual += prodAktual;
                    filteredData.kpi.ytd.ohkAktual += ohkAktual;
                    
                    // (Target YTD diambil dari data bulanan di bawah)
                }

                // 3. Hitung Data Detail (Afdeling, Mandor, dll)
                const afd = row.Afdeling;
                const mdr = row.Mandor;
                const asf = row.Asisten_Afdeling;
                const tt = row.Tahun_Tanam;
                const tapperKey = `${row.Afdeling}-${row.Mandor}-${row.Tapper}`;

                // Loop untuk mengisi semua detail
                [afd, mdr, asf, tt, tapperKey].forEach((key, index) => {
                    let detailType;
                    switch (index) {
                        case 0: detailType = 'afdeling'; break;
                        case 1: detailType = 'mandor'; break;
                        case 2: detailType = 'asisten'; break;
                        case 3: detailType = 'tahuntanam'; break;
                        case 4: detailType = 'tapper'; break;
                    }
                    
                    const entry = filteredData.details[detailType][key];
                    
                    if (entry) {
                        // Hari Ini
                        if (row.Tanggal === filterTglString) {
                            entry.todayAktual += prodAktual;
                            entry.todayRKAP += prodRKAP;
                            if (detailType === 'tapper') entry.hancaWajib = hancaWajib; // Ambil Hanca Wajib hari ini
                        }
                        
                        // Bulan Ini
                        if (rowBulan === filterBulan) {
                            entry.monthAktual += prodAktual;
                            entry.monthRKAP += prodRKAP; // Asumsi RKAP harian
                        }
                        
                        // YTD (s.d. Tanggal Filter)
                        if (rowDate <= filterDateObj) {
                            entry.ytdAktual += prodAktual;
                            entry.ytdRKAP += prodRKAP; // Akumulasi RKAP harian
                        }
                    }
                });
            });

            // 4. Hitung Target YTD (KPI & Detail)
            // (Akumulasi dari target bulanan penuh di data bulanan)
            for (let i = 0; i <= filterBulan; i++) {
                // KPI YTD
                filteredData.kpi.ytd.prodRKAP += filteredData.bulanan.produksi[i].rkap;
                filteredData.kpi.ytd.prod2024 += filteredData.bulanan.produksi[i].prevYear;
                filteredData.kpi.ytd.ohkRKAP += filteredData.bulanan.ohk[i].rkap;
                filteredData.kpi.ytd.ohk2024 += filteredData.bulanan.ohk[i].prevYear;
                
                // (Catatan: Ini akan mengambil target YTD penuh s.d. akhir bulan filter)
                // (Jika ingin apple-to-apple, kita harus menjumlahkan RKAP harian di loop sebelumnya)
                // (Saat ini, KPI YTD membandingkan Aktual Harian vs Target RKAP Harian)
                // (Dan KPI YTD Persen membandingkan Aktual YTD vs RKAP Bulanan YTD)
                
                // Mari kita sesuaikan agar KPI YTD (angka) juga menggunakan RKAP Harian
                // Biarkan seperti ini dulu (Aktual YTD vs RKAP YTD Bulanan)
            }

            console.log("Selesai filter data.", filteredData);
            return filteredData;
        }


        /* ------------------------------------- */
        /* Fungsi Update UI (KPI)         */
        /* ------------------------------------- */

        function updateKPIs(kpiData) {
            const kpiToday = kpiData.today;
            const kpiYTD = kpiData.ytd;

            // 1. KPI Produksi Hari Ini
            document.getElementById('kpi-prod-today-value').textContent = formatAngka(kpiToday.prodAktual);
            updateComparisonClass(document.getElementById('kpi-prod-today-rkap'), kpiToday.prodAktual, kpiToday.prodRKAP);
            updateComparisonClass(document.getElementById('kpi-prod-today-2024'), kpiToday.prodAktual, kpiToday.prod2024);

            // 2. KPI Produksi YTD
            document.getElementById('kpi-prod-ytd-value').textContent = formatAngka(kpiYTD.prodAktual);
            const prodYtdPercent = hitungPersen(kpiYTD.prodAktual, kpiYTD.prodRKAP);
            updatePercentClass(document.getElementById('kpi-prod-ytd-percent'), prodYtdPercent);

            // 3. KPI OHK Hari Ini
            document.getElementById('kpi-ohk-today-value').textContent = formatAngka(kpiToday.ohkAktual);
            updateComparisonClass(document.getElementById('kpi-ohk-today-rkap'), kpiToday.ohkAktual, kpiToday.ohkRKAP);
            updateComparisonClass(document.getElementById('kpi-ohk-today-2024'), kpiToday.ohkAktual, kpiToday.ohk2024);

            // 4. KPI OHK YTD
            document.getElementById('kpi-ohk-ytd-value').textContent = formatAngka(kpiYTD.ohkAktual);
            const ohkYtdPercent = hitungPersen(kpiYTD.ohkAktual, kpiYTD.ohkRKAP);
            updatePercentClass(document.getElementById('kpi-ohk-ytd-percent'), ohkYtdPercent);
        }

        /* ------------------------------------- */
        /* Fungsi Update UI (Tabel)         */
        /* ------------------------------------- */

        /*
         * Fungsi generik untuk update tabel detail (Afdeling, Mandor, Asisten, T. Tanam)
         */
        function updateDetailTable(tableSelector, data) {
            const tableBody = document.querySelector(`${tableSelector} tbody`);
            const tableFooter = document.querySelector(`${tableSelector} tfoot`);
            if (!tableBody || !tableFooter) return;

            tableBody.innerHTML = ''; // Kosongkan
            let html = '';

            // Inisialisasi Total
            const total = createDetailEntry(0);

            // Urutkan data (misalnya berdasarkan nama key)
            const sortedKeys = Object.keys(data).sort();

            sortedKeys.forEach(key => {
                const item = data[key];

                // Akumulasi total
                total.luasHa += item.luasHa;
                total.todayAktual += item.todayAktual;
                total.todayRKAP += item.todayRKAP;
                total.monthAktual += item.monthAktual;
                total.monthRKAP += item.monthRKAP;
                total.ytdAktual += item.ytdAktual;
                total.ytdRKAP += item.ytdRKAP;
                
                // Hitung persen YTD
                const ytdAktualPercent = hitungPersen(item.ytdAktual, item.ytdAktual); // (Ini harusnya vs YTD Aktual Total?)
                const ytdRKAPPercent = hitungPersen(item.ytdAktual, item.ytdRKAP); // (Ini persen vs RKAP)

                html += `
                <tr>
                    <td class="text-left">${key}</td>
                    <td>${formatAngka(item.luasHa)}</td>
                    <td>${formatAngka(item.todayAktual)}</td>
                    <td>${formatAngka(item.todayRKAP)}</td>
                    <td>${formatAngka(item.monthAktual)}</td>
                    <td>${formatAngka(item.monthRKAP)}</td>
                    <td>${formatAngka(item.ytdAktual)}</td>
                    <td>${formatAngka(item.ytdRKAP)}</td>
                    <td>${ytdAktualPercent.toFixed(1).replace('.', ',')}%</td> 
                    <td>${ytdRKAPPercent.toFixed(1).replace('.', ',')}%</td>
                </tr>
                `;
            });

            tableBody.innerHTML = html;

            // Update Footer (Total)
            const totalYtdAktualPercent = hitungPersen(total.ytdAktual, total.ytdAktual); // (Percent to self)
            const totalYtdRKAPPercent = hitungPersen(total.ytdAktual, total.ytdRKAP); // (Percent to RKAP)
            
            tableFooter.innerHTML = `
            <tr>
                <td class="text-left" style="text-align: center;" colspan="1"><b>TOTAL</b></td>
                <td><b>${formatAngka(total.luasHa)}</b></td>
                <td><b>${formatAngka(total.todayAktual)}</b></td>
                <td><b>${formatAngka(total.todayRKAP)}</b></td>
                <td><b>${formatAngka(total.monthAktual)}</b></td>
                <td><b>${formatAngka(total.monthRKAP)}</b></td>
                <td><b>${formatAngka(total.ytdAktual)}</b></td>
                <td><b>${formatAngka(total.ytdRKAP)}</b></td>
                <td><b>${totalYtdAktualPercent.toFixed(1).replace('.', ',')}%</b></td>
                <td><b>${totalYtdRKAPPercent.toFixed(1).replace('.', ',')}%</b></td>
            </tr>
            `;
        }

        /*
         * Fungsi spesifik untuk update tabel Tapper (struktur kolom berbeda)
         */
        function updateTapperTable(data) {
            const tableBody = document.querySelector('#tapper-table tbody');
            const tableFooter = document.querySelector('#tapper-table tfoot');
            if (!tableBody || !tableFooter) return;

            tableBody.innerHTML = '';
            let html = '';
            const total = createDetailEntry(0);
            total.hancaWajib = 0;

            const sortedKeys = Object.keys(data).sort();

            sortedKeys.forEach(key => {
                const item = data[key];

                // Akumulasi total
                total.hancaWajib += item.hancaWajib;
                total.todayAktual += item.todayAktual;
                total.todayRKAP += item.todayRKAP;
                total.monthAktual += item.monthAktual;
                total.monthRKAP += item.monthRKAP;
                total.ytdAktual += item.ytdAktual;
                total.ytdRKAP += item.ytdRKAP;
                
                const ytdAktualPercent = hitungPersen(item.ytdAktual, item.ytdAktual);
                const ytdRKAPPercent = hitungPersen(item.ytdAktual, item.ytdRKAP);

                html += `
                <tr>
                    <td class="text-left">${item.afdeling}</td>
                    <td class="text-left">${item.mandor}</td>
                    <td>${formatAngka(item.hancaWajib)}</td>
                    <td>${formatAngka(item.todayAktual)}</td>
                    <td>${formatAngka(item.todayRKAP)}</td>
                    <td>${formatAngka(item.monthAktual)}</td>
                    <td>${formatAngka(item.monthRKAP)}</td>
                    <td>${formatAngka(item.ytdAktual)}</td>
                    <td>${formatAngka(item.ytdRKAP)}</td>
                    <td>${ytdAktualPercent.toFixed(1).replace('.', ',')}%</td>
                    <td>${ytdRKAPPercent.toFixed(1).replace('.', ',')}%</td>
                </tr>
                `;
            });

            tableBody.innerHTML = html;

            // Update Footer
            const totalYtdAktualPercent = hitungPersen(total.ytdAktual, total.ytdAktual);
            const totalYtdRKAPPercent = hitungPersen(total.ytdAktual, total.ytdRKAP);

            tableFooter.innerHTML = `
            <tr>
                <td class="text-left" style="text-align: center;" colspan="2"><b>TOTAL</b></td>
                <td><b>${formatAngka(total.hancaWajib)}</b></td>
                <td><b>${formatAngka(total.todayAktual)}</b></td>
                <td><b>${formatAngka(total.todayRKAP)}</b></td>
                <td><b>${formatAngka(total.monthAktual)}</b></td>
                <td><b>${formatAngka(total.monthRKAP)}</b></td>
                <td><b>${formatAngka(total.ytdAktual)}</b></td>
                <td><b>${formatAngka(total.ytdRKAP)}</b></td>
                <td><b>${totalYtdAktualPercent.toFixed(1).replace('.', ',')}%</b></td>
                <td><b>${totalYtdRKAPPercent.toFixed(1).replace('.', ',')}%</b></td>
            </tr>
            `;
        }


        /* ------------------------------------- */
        /* Fungsi Update UI (Chart)       */
        /* ------------------------------------- */

        /*
         * Render Chart Produksi Bulanan (Bar & Line Combo)
         */
        function renderMonthlyChart(dataBulanan, filterBulan, filterTahun) {
            const ctx = document.getElementById('produksiChart').getContext('2d');

            // Data untuk chart (potong sampai bulan filter)
            const labels = BULAN_LABELS.slice(0, filterBulan + 1);
            const dataAktual2025 = dataBulanan.map(d => d.aktual).slice(0, filterBulan + 1);
            const dataAktual2024 = dataBulanan.map(d => d.prevYear).slice(0, filterBulan + 1);
            const dataRKAP = dataBulanan.map(d => d.rkap).slice(0, filterBulan + 1);

            // Hancurkan chart lama jika ada
            if (prodChartInstance) {
                prodChartInstance.destroy();
            }

            prodChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '2025 (Aktual)',
                            data: dataAktual2025,
                            backgroundColor: WARNA_BIRU,
                            borderColor: WARNA_BIRU,
                            borderWidth: 1,
                            type: 'bar', // Tipe Bar
                            order: 2 // Urutan render
                        },
                        {
                            label: '2024 (Aktual)',
                            data: dataAktual2024,
                            backgroundColor: WARNA_ABU,
                            borderColor: WARNA_ABU,
                            borderWidth: 1,
                            type: 'bar', // Tipe Bar
                            order: 3
                        },
                         {
                            label: 'RKAP',
                            data: dataRKAP,
                            backgroundColor: 'transparent',
                            borderColor: WARNA_MERAH,
                            borderWidth: 3, // Lebih tebal
                            pointRadius: 4, // Ada titik
                            type: 'line', // Tipe Garis
                            order: 1,
                            tension: 0.1
                        }
                    ]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Produksi Per Bulan (Kg)',
                            font: { size: 16, weight: '600' },
                            padding: { bottom: 16 }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatAngka(context.parsed.y) + ' Kg';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            align: 'top',
                            anchor: 'end',
                            color: '#444',
                            font: { weight: '600', size: 10 },
                            formatter: (value, context) => {
                                // Hanya tampilkan label untuk bar (order > 1)
                                if (context.dataset.order > 1) {
                                    return formatAngkaSingkat(value);
                                }
                                return null; // Sembunyikan label untuk garis
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            grid: { display: false }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Produksi (Kg)'
                            },
                            ticks: {
                                callback: function (value) {
                                    return formatAngkaSingkat(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /*
         * Render Chart OHK Bulanan (Grouped Bar)
         */
        function renderOHKChart(dataBulanan, filterBulan, filterTahun) {
             const ctx = document.getElementById('ohkChart').getContext('2d');

            // Data untuk chart (potong sampai bulan filter)
            const labels = BULAN_LABELS.slice(0, filterBulan + 1);
            const dataAktual2025 = dataBulanan.map(d => d.aktual).slice(0, filterBulan + 1);
            const dataAktual2024 = dataBulanan.map(d => d.prevYear).slice(0, filterBulan + 1);
            const dataRKAP = dataBulanan.map(d => d.rkap).slice(0, filterBulan + 1);
            
            if (ohkChartInstance) {
                ohkChartInstance.destroy();
            }

            ohkChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '2025 (Aktual)',
                            data: dataAktual2025,
                            backgroundColor: WARNA_BIRU,
                        },
                        {
                            label: '2024 (Aktual)',
                            data: dataAktual2024,
                            backgroundColor: WARNA_ABU,
                        },
                        {
                            label: 'RKAP',
                            data: dataRKAP,
                            backgroundColor: WARNA_MERAH,
                        }
                    ]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'OHK Per Bulan (OHK)',
                            font: { size: 16, weight: '600' },
                            padding: { bottom: 16 }
                        },
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                             mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatAngka(context.parsed.y) + ' OHK';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            align: 'top',
                            anchor: 'end',
                            color: '#444',
                            font: { weight: '600', size: 10 },
                            formatter: (value) => formatAngkaSingkat(value)
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'OHK (Orang Hari Kerja)'
                            },
                             ticks: {
                                callback: function (value) {
                                    return formatAngkaSingkat(value);
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>

